# Email Setup Guide

## Nodemailer Email Integration

Email notifications are now configured for:
- ✅ Booking confirmation
- ✅ Trip completion
- ✅ Booking cancellation

## Setup Instructions

### Option 1: Gmail (Recommended for Development)

1. **Enable 2-Factor Authentication** on your Gmail account
   - Go to: https://myaccount.google.com/security
   - Enable 2-Step Verification

2. **Create an App Password**
   - Go to: https://myaccount.google.com/apppasswords
   - Select app: "Mail"
   - Select device: "Other" (Custom name: Fleet Management)
   - Click "Generate"
   - Copy the 16-digit password

3. **Update .env file**
   ```env
   EMAIL_USER=your-email@gmail.com
   EMAIL_PASS=xxxx xxxx xxxx xxxx  # 16-digit app password (remove spaces)
   EMAIL_FROM=Fleet Management <noreply@fleetmanagement.com>
   ```

### Option 2: Other Email Providers

#### SendGrid
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
EMAIL_USER=apikey
EMAIL_PASS=your-sendgrid-api-key
```

#### Mailgun
```env
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
EMAIL_USER=postmaster@your-domain.mailgun.org
EMAIL_PASS=your-mailgun-password
```

#### AWS SES
```env
SMTP_HOST=email-smtp.us-east-1.amazonaws.com
SMTP_PORT=587
EMAIL_USER=your-ses-smtp-username
EMAIL_PASS=your-ses-smtp-password
```

## Testing Emails

### 1. Test Booking Confirmation
Create a new booking via the customer dashboard:
- Go to `/dashboard/customer/vehicles`
- Select a vehicle and create a booking
- Check your email for confirmation

### 2. Test Trip Completion
Complete a trip via the driver dashboard:
- Owner assigns driver to booking
- Driver starts the trip
- Driver completes the trip
- Customer receives completion email

### 3. Test Cancellation
Cancel a booking via the customer dashboard:
- Go to `/dashboard/customer/bookings`
- Cancel a pending or confirmed booking
- Check email for cancellation confirmation

## Email Templates

The emails include:
- Beautiful HTML templates with responsive design
- Booking details (ID, vehicle, dates, locations)
- Action buttons to view details
- Professional branding

## Troubleshooting

### Gmail "Less Secure Apps" Error
- Gmail no longer supports "less secure apps"
- You MUST use App Passwords (see Option 1 above)

### Emails Not Sending
1. Check console logs for email errors
2. Verify EMAIL_USER and EMAIL_PASS in .env
3. Check spam folder
4. Verify email format in user profile

### Email Fails Silently
- Emails are sent asynchronously (won't block API response)
- Check backend console for error messages
- Email failures won't affect booking/trip operations

## Production Recommendations

1. **Use a dedicated email service**: SendGrid, Mailgun, or AWS SES
2. **Set up SPF/DKIM records** for better deliverability
3. **Use email templates** from a service like SendGrid Templates
4. **Add email queue** with Bull/Redis for reliability
5. **Monitor email delivery** with webhooks
6. **Add unsubscribe links** for marketing emails

## Email Queue (Future Enhancement)

For production, consider adding Bull queue:

```bash
npm install bull @types/bull
```

Create email queue to handle failures and retries.

## Security Notes

- Never commit .env file with real credentials
- Use environment variables in production
- Rotate email passwords regularly
- Monitor for suspicious email activity
- Rate limit email sending to prevent abuse

## Files Modified

1. `backend/src/config/email.ts` - Email configuration
2. `backend/src/services/emailService.ts` - Email templates and sending logic
3. `backend/src/controllers/bookingController.ts` - Integrated email triggers
4. `backend/.env` - Email credentials (DO NOT COMMIT)

## Next Steps

1. Update .env with your email credentials
2. Restart the backend server
3. Test each email trigger
4. Customize email templates as needed
5. Set up proper email service for production
